<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Comprehensive Image/File Difference Finder</title>
    <style>
        /* [YOUR EXISTING CSS REMAINS HERE] */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        h1 {
            text-align: center;
            color: #667eea;
            margin-bottom: 10px;
            font-size: 2.5em;
        }

        .subtitle {
            text-align: center;
            color: #666;
            margin-bottom: 40px;
            font-size: 1.1em;
        }

        .upload-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 10px;
        }

        .upload-box {
            border: 3px dashed #667eea;
            border-radius: 15px;
            padding: 40px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background: #f8f9ff;
        }

        .upload-box:hover {
            background: #eef1ff;
            border-color: #764ba2;
            transform: translateY(-5px);
        }

        .upload-box.active {
            border-color: #48bb78;
            background: #f0fff4;
        }

        .upload-box h3 {
            color: #667eea;
            margin-bottom: 15px;
            font-size: 1.3em;
        }

        .upload-box p {
            color: #666;
            margin-bottom: 15px;
        }

        input[type="file"] {
            display: none;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 40px;
            border-radius: 50px;
            cursor: pointer;
            font-size: 1.1em;
            font-weight: 600;
            transition: all 0.3s ease;
            display: inline-block;
            margin-top: 10px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }

        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .compare-btn {
            text-align: center;
            margin-bottom: 30px;
        }

        .preview-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }

        .preview-box {
            text-align: center;
        }

        .preview-box h3 {
            color: #667eea;
            margin-bottom: 15px;
            font-size: 1.2em;
        }

        .preview-box img {
            max-width: 100%;
            max-height: 400px;
            border-radius: 10px;
            box-shadow: 0 0 15px rgba(0,0,0,0.1);
            object-fit: contain;
        }
        
        .preview-box .file-info {
            height: 400px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px solid #ddd;
            border-radius: 10px;
            background: #f9f9f9;
            flex-direction: column;
            padding: 20px;
        }
        
        .file-info p {
            color: #333;
            font-size: 1.1em;
            font-weight: 500;
        }
        
        .file-info .icon {
            font-size: 3em;
            color: #e53e3e;
            margin-bottom: 10px;
        }

        .canvas-container {
            margin-bottom: 30px;
            text-align: center;
        }

        .canvas-container h3 {
            color: #667eea;
            margin-bottom: 15px;
            font-size: 1.3em;
        }

        #diffCanvas {
            max-width: 100%;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            background: white;
        }

        .differences-list {
            background: #f8f9ff;
            border-radius: 15px;
            padding: 30px;
            margin-top: 30px;
        }

        .differences-list h3 {
            color: #667eea;
            margin-bottom: 20px;
            font-size: 1.3em;
        }
        /* Adjusted grid to fit 5 stats now: Pixel, Similarity, MSE, RMSE/Diff, Resolution */
        .diff-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .stat-box {
            background: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }

        .stat-value {
            font-size: 2em;
            font-weight: 700;
            color: #667eea;
            margin-bottom: 5px;
        }
        
        /* Highlight new metric */
        .stat-box.mse .stat-value {
            color: #e53e3e; /* Red/Orange for error metric */
        }

        .stat-label {
            color: #666;
            font-size: 0.9em;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #667eea;
            font-size: 1.2em;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .slider-container {
            margin: 20px 0;
            text-align: center;
        }

        .slider-container label {
            display: block;
            margin-bottom: 10px;
            color: #667eea;
            font-weight: 600;
        }

        input[type="range"] {
            width: 300px;
            margin: 10px;
        }
        
        .disclaimer {
            text-align: center;
            color: #e53e3e;
            font-size: 0.9em;
            margin-bottom: 30px;
            padding: 10px;
            border: 1px solid #fed7d7;
            background: #fff5f5;
            border-radius: 8px;
        }

        @media (max-width: 768px) {
            .upload-section, .preview-section {
                grid-template-columns: 1fr;
            }

            h1 {
                font-size: 1.8em;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç Comprehensive File Comparison</h1>
        <p class="subtitle">Detailed analysis using multiple quantitative metrics and Gemini AI's qualitative assessment.</p>

        <div class="upload-section">
            <div class="upload-box" id="upload1" onclick="document.getElementById('file1').click()">
                <h3>File 1</h3>
                <p>Click to upload first file (Image/PDF)</p>
                <div style="font-size: 3em;">üìÑ</div>
            </div>
            <div class="upload-box" id="upload2" onclick="document.getElementById('file2').click()">
                <h3>File 2</h3>
                <p>Click to upload second file (Image/PDF)</p>
                <div style="font-size: 3em;">üìÑ</div>
            </div>
        </div>

        <div class="disclaimer">
            ‚ö†Ô∏è **Note on PDF:** This is a *frontend-only* tool. **Pixel Comparison** and **Preview** features will not work for PDFs. The **Gemini AI Analysis** is still attempted but only works if the Gemini API supports the specific PDF comparison. **Image files are fully supported.**
        </div>

        <input type="file" id="file1" accept="image/*, application/pdf">
        <input type="file" id="file2" accept="image/*, application/pdf">

        <div class="preview-section" id="previewSection" style="display: none;">
            <div class="preview-box">
                <h3>File 1 Preview</h3>
                <img id="preview1" alt="File 1" style="display: none;">
                <div id="fileInfo1" class="file-info" style="display: none;">
                    <span class="icon">üìÅ</span>
                    <p id="fileName1"></p>
                </div>
            </div>
            <div class="preview-box">
                <h3>File 2 Preview</h3>
                <img id="preview2" alt="File 2" style="display: none;">
                <div id="fileInfo2" class="file-info" style="display: none;">
                    <span class="icon">üìÅ</span>
                    <p id="fileName2"></p>
                </div>
            </div>
        </div>

        <div class="slider-container" id="sensitivityControl" style="display: none;">
            <label for="sensitivity">Pixel Difference Sensitivity: <span id="sensitivityValue">30</span></label>
            <input type="range" id="sensitivity" min="1" max="100" value="30">
            <p style="color: #666; font-size: 0.9em; margin-top: 5px;">Lower = more sensitive pixel detection (Only works for images)</p>
        </div>

        <div class="compare-btn">
            <button class="btn" id="compareBtn" onclick="compareImages()" disabled>Run Comprehensive Comparison</button>
        </div>

        <div id="loadingSection" style="display: none;">
            <div class="loading">
                <div class="spinner"></div>
                Running both Pixel Analysis and Gemini AI Semantic Analysis...
            </div>
        </div>

        <div class="canvas-container" id="canvasSection" style="display: none;">
            <h3>Pixel Differences Highlighted (Red)</h3>
            <canvas id="diffCanvas"></canvas>
            <p id="canvasNote" style="color: #666; margin-top: 10px;">(This visualization is only active for image files.)</p>
        </div>

        <div class="differences-list" id="differencesList" style="display: none;">
            <h3>Analysis Results</h3>
            <div class="diff-stats" id="diffStats"></div>
            <p id="geminiResult" style="margin-top: 20px;"></p>
        </div>
    </div>

    <script>
        // üö® SECURITY WARNING: Embedding the API key here is NOT recommended for production.
        const GEMINI_API_KEY = "AIzaSyBLxoVx-RkuJeja6n_7JqrJ_O-S_teRhuA"; 
        const GEMINI_ENDPOINT = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${GEMINI_API_KEY}`;

        let img1 = null; 
        let img2 = null; 
        let img1Base64 = null;
        let img2Base64 = null;

        document.getElementById('file1').addEventListener('change', function(e) {
            handleFileUpload(e, 1);
        });

        document.getElementById('file2').addEventListener('change', function(e) {
            handleFileUpload(e, 2);
        });

        document.getElementById('sensitivity').addEventListener('input', function(e) {
            document.getElementById('sensitivityValue').textContent = e.target.value;
            if (img1 && img2) { 
                runPixelComparison(); 
            }
        });

        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => {
                    const parts = reader.result.split(',');
                    const base64String = parts.length > 1 ? parts[1] : reader.result;
                    const mimeType = reader.result.split(';')[0].split(':')[1];
                    resolve({ base64: base64String, mime: mimeType, name: file.name });
                };
                reader.onerror = error => reject(error);
            });
        }

        async function handleFileUpload(event, imageNumber) {
            const file = event.target.files[0];
            if (!file) return;

            const base64Data = await fileToBase64(file);

            const isImage = file.type.startsWith('image/');
            const previewElement = document.getElementById(`preview${imageNumber}`);
            const fileInfoElement = document.getElementById(`fileInfo${imageNumber}`);
            const fileNameElement = document.getElementById(`fileName${imageNumber}`);
            const uploadBox = document.getElementById(`upload${imageNumber}`);
            
            previewElement.style.display = 'none';
            fileInfoElement.style.display = 'none';
            uploadBox.classList.remove('active');

            if (isImage) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const img = new Image();
                    img.onload = function() {
                        if (imageNumber === 1) {
                            img1 = img;
                            img1Base64 = base64Data;
                        } else {
                            img2 = img;
                            img2Base64 = base64Data;
                        }

                        previewElement.src = e.target.result;
                        previewElement.style.display = 'block';
                        uploadBox.classList.add('active');
                        checkComparisonReady();
                    };
                    img.src = e.target.result;
                };
                reader.readAsDataURL(file);
            } else {
                if (imageNumber === 1) {
                    img1 = null;
                    img1Base64 = base64Data;
                } else {
                    img2 = null;
                    img2Base64 = base64Data;
                }
                
                fileNameElement.textContent = file.name;
                fileInfoElement.style.display = 'flex';
                uploadBox.classList.add('active');
                checkComparisonReady();
            }
        }
        
        function checkComparisonReady() {
            if (img1Base64 && img2Base64) {
                document.getElementById('previewSection').style.display = 'grid';
                document.getElementById('compareBtn').disabled = false;
                
                if (img1 && img2) {
                    document.getElementById('sensitivityControl').style.display = 'block';
                } else {
                    document.getElementById('sensitivityControl').style.display = 'none';
                }
            }
        }

        async function compareImages() {
            if (!img1Base64 || !img2Base64) return;

            document.getElementById('loadingSection').style.display = 'block';
            document.getElementById('differencesList').style.display = 'block';
            document.getElementById('geminiResult').innerHTML = 'Running visual and AI analysis...';
            document.getElementById('diffStats').innerHTML = '';
            document.getElementById('canvasSection').style.display = 'none';

            // --- 1. Client-Side Pixel Comparison (Quantitative Metrics) ---
            if (img1 && img2) {
                runPixelComparison();
            } else {
                document.getElementById('canvasSection').style.display = 'none';
                document.getElementById('diffStats').innerHTML = `
                    <div class="stat-box">
                        <div class="stat-value">N/A</div>
                        <div class="stat-label">Pixel Difference</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value">N/A</div>
                        <div class="stat-label">Pixel Similarity</div>
                    </div>
                    <div class="stat-box mse">
                        <div class="stat-value">N/A</div>
                        <div class="stat-label">MSE (Pixel Error)</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value">N/A</div>
                        <div class="stat-label">RMSE (Approx)</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value">File Only</div>
                        <div class="stat-label">Mode</div>
                    </div>
                `;
            }

            // --- 2. Gemini AI Qualitative Comparison (Semantic Analysis) ---
            try {
                // IMPROVED PROMPT for more structured output and better file handling
                const prompt = `Perform a comprehensive comparison of the two provided files. File 1 is named '${img1Base64.name}' and File 2 is named '${img2Base64.name}'.
                
                **TASK:**
                1.  **Identify and list all semantic differences** in a clear, numbered list (e.g., "Object X moved," "Color Y changed," "Text Z added").
                2.  **Provide a concise summary** of the *most significant* difference.
                3.  **Offer a confidence score** (0-100%) in your ability to detect the differences based on the file types/content.

                Start your response directly with the numbered list of differences. Do not include any introductory text, but use markdown formatting for the summary and confidence score.`;
                
                const payload = {
                    contents: [{
                        parts: [
                            { text: prompt },
                            { inlineData: { mimeType: img1Base64.mime, data: img1Base64.base64 } },
                            { text: "File 2:" },
                            { inlineData: { mimeType: img2Base64.mime, data: img2Base64.base64 } }
                        ]
                    }],
                    generationConfig: { 
                        temperature: 0.2 
                    }
                };

                const response = await fetch(GEMINI_ENDPOINT, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(`API Error (${response.status}): ${errorData.error?.message || response.statusText}`);
                }

                const data = await response.json();
                const geminiText = data.candidates[0].content.parts[0].text;

                document.getElementById('geminiResult').innerHTML = `
                    <h4>Gemini AI Qualitative Analysis:</h4>
                    <div style="padding: 15px; background: white; border-radius: 8px; border: 1px solid #ddd; white-space: pre-wrap;">
                        ${geminiText.trim()}
                    </div>
                `;

            } catch (error) {
                console.error('Gemini API Error:', error);
                document.getElementById('geminiResult').innerHTML = `
                    <h4>Gemini AI Qualitative Analysis:</h4>
                    <p style="color: red;">Error during AI analysis. Please check the browser console for details.<br>Error: ${error.message}</p>
                `;
            } finally {
                document.getElementById('loadingSection').style.display = 'none';
            }
        }

        /**
         * UPDATED: Now calculates Mean Squared Error (MSE) and Root Mean Square Error (RMSE)
         * alongside the basic pixel difference count.
         */
        function runPixelComparison() {
            const canvas = document.getElementById('diffCanvas');
            const ctx = canvas.getContext('2d');

            if (!img1 || !img2) return;

            const maxWidth = Math.max(img1.width, img2.width);
            const maxHeight = Math.max(img1.height, img2.height);

            canvas.width = maxWidth;
            canvas.height = maxHeight;

            const tempCanvas1 = document.createElement('canvas');
            const tempCanvas2 = document.createElement('canvas');
            tempCanvas1.width = tempCanvas2.width = maxWidth;
            tempCanvas1.height = tempCanvas2.height = maxHeight;

            const ctx1 = tempCanvas1.getContext('2d');
            const ctx2 = tempCanvas2.getContext('2d');

            ctx1.drawImage(img1, 0, 0);
            ctx2.drawImage(img2, 0, 0);

            const imageData1 = ctx1.getImageData(0, 0, maxWidth, maxHeight);
            const imageData2 = ctx2.getImageData(0, 0, maxWidth, maxHeight);
            const diffData = ctx.createImageData(maxWidth, maxHeight);

            const sensitivity = parseInt(document.getElementById('sensitivity').value);
            let diffPixels = 0;
            let totalPixels = maxWidth * maxHeight;
            let sumSquaredError = 0; // For MSE calculation

            for (let i = 0; i < imageData1.data.length; i += 4) {
                const r1 = imageData1.data[i];
                const g1 = imageData1.data[i + 1];
                const b1 = imageData1.data[i + 2];
                
                const r2 = imageData2.data[i];
                const g2 = imageData2.data[i + 1];
                const b2 = imageData2.data[i + 2];

                // Check difference using Euclidean distance (used for visualization)
                const diffMagnitude = Math.sqrt(Math.pow(r1 - r2, 2) + Math.pow(g1 - g2, 2) + Math.pow(b1 - b2, 2));

                // Calculate the squared difference for MSE (sum of all color channels)
                const rDiff = r1 - r2;
                const gDiff = g1 - g2;
                const bDiff = b1 - b2;
                sumSquaredError += (rDiff * rDiff) + (gDiff * gDiff) + (bDiff * bDiff);

                if (diffMagnitude > sensitivity) {
                    diffData.data[i] = 255; // Red
                    diffData.data[i + 1] = 0;
                    diffData.data[i + 2] = 0;
                    diffData.data[i + 3] = 255;
                    diffPixels++;
                } else {
                    diffData.data[i] = (r1 + r2) / 2; // Mid-tone
                    diffData.data[i + 1] = (g1 + g2) / 2;
                    diffData.data[i + 2] = (b1 + b2) / 2;
                    diffData.data[i + 3] = 255;
                }
            }

            ctx.putImageData(diffData, 0, 0);

            // Calculate final metrics
            const percentDiff = ((diffPixels / totalPixels) * 100).toFixed(2);
            const similarity = (100 - percentDiff).toFixed(2);
            
            // MSE: Sum of squared errors across all 3 color channels divided by total channels (3 * totalPixels)
            const mse = (sumSquaredError / (3 * totalPixels)).toFixed(4);
            
            // RMSE: Square root of MSE (Root Mean Squared Error)
            const rmse = Math.sqrt(sumSquaredError / (3 * totalPixels)).toFixed(2);

            // Display comprehensive quantitative stats
            document.getElementById('diffStats').innerHTML = `
                <div class="stat-box">
                    <div class="stat-value">${percentDiff}%</div>
                    <div class="stat-label">Pixel Difference</div>
                </div>
                <div class="stat-box">
                    <div class="stat-value">${similarity}%</div>
                    <div class="stat-label">Pixel Similarity</div>
                </div>
                <div class="stat-box mse">
                    <div class="stat-value">${mse}</div>
                    <div class="stat-label">MSE (Avg. Squared Error)</div>
                </div>
                <div class="stat-box">
                    <div class="stat-value">${rmse}</div>
                    <div class="stat-label">RMSE (Avg. Pixel Error)</div>
                </div>
                <div class="stat-box">
                    <div class="stat-value">${maxWidth} √ó ${maxHeight}</div>
                    <div class="stat-label">Resolution</div>
                </div>
            `;

            document.getElementById('canvasSection').style.display = 'block';
        }
    </script>
</body>
</html>